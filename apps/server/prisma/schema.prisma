generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Target {
  id                String    @id @default(uuid())
  url               String
  type              String    @default("web") // web, api, mobile
  status            String    @default("discovering") // discovering, learning, established, blocked, paused
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastSeen          DateTime?
  
  // Green Light
  greenLightStatus  String    @default("RED") // RED, YELLOW, GREEN, ESTABLISHED
  trustScore        Int       @default(0)
  establishedAt     DateTime?
  maintainedFor     Int       @default(0) // seconds
  
  // Relations
  currentDnaId      String?
  currentDna        DnaSnapshot? @relation("CurrentDNA", fields: [currentDnaId], references: [id])
  
  dnaSnapshots      DnaSnapshot[]
  learningEvents    LearningEvent[]
  greenLightHistory GreenLightState[]
  requestLogs       RequestLog[]
  
  @@index([url])
  @@index([status])
  @@index([greenLightStatus])
}

model DnaSnapshot {
  id          String   @id @default(uuid())
  targetId    String
  target      Target   @relation(fields: [targetId], references: [id])
  
  version     String   @default("1.0.0")
  dnaJson     String   // The complete DNA object (JSON string)
  
  // Genealogy
  parentId    String?
  parent      DnaSnapshot? @relation("DNALineage", fields: [parentId], references: [id])
  children    DnaSnapshot[] @relation("DNALineage")
  
  isActive    Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  // Relations
  currentFor  Target[] @relation("CurrentDNA")
  events      LearningEvent[]
  requests    RequestLog[]
  
  @@index([targetId])
  @@index([isActive])
}

model LearningEvent {
  id          String   @id @default(uuid())
  targetId    String
  target      Target   @relation(fields: [targetId], references: [id])
  
  dnaVersionId String
  dnaVersion   DnaSnapshot @relation(fields: [dnaVersionId], references: [id])
  
  eventType   String   // birth, mutation, challenge, milestone, failure, mcp_decision
  title       String
  description String
  
  // MCP Data
  mcpInsight      String?
  mcpConfidence   Float?
  mcpModel        String   @default("claude-4-5-sonnet-2026x")
  
  // DNA Changes
  dnaChanges      String?    // { added: [], removed: [], modified: [] } (JSON string)
  beforeState     String?
  afterState      String?
  
  // Metrics
  trustImpact     Int      @default(0)
  durationMs      Int?
  
  // Challenge specific
  challengeType   String?
  challengeSolved Boolean?
  
  createdAt       DateTime @default(now())
  
  @@index([targetId])
  @@index([eventType])
  @@index([createdAt])
}

model GreenLightState {
  id          String   @id @default(uuid())
  targetId    String
  target      Target   @relation(fields: [targetId], references: [id])
  
  status      String   // RED, YELLOW, GREEN, ESTABLISHED
  trustScore  Int
  signalsJson String   // Detailed signals breakdown (JSON string)
  
  establishedAt   DateTime?
  maintainedFor   Int       @default(0) // seconds
  
  lostAt          DateTime?
  reasonLost      String?
  
  createdAt       DateTime @default(now())
  
  @@index([targetId])
  @@index([status])
}

model RequestLog {
  id          String   @id @default(uuid())
  targetId    String
  target      Target   @relation(fields: [targetId], references: [id])
  
  dnaVersionId String?
  dnaVersion   DnaSnapshot? @relation(fields: [dnaVersionId], references: [id])
  
  method      String
  url         String
  headers     String   // JSON string
  body        String?
  
  responseStatus      Int?
  responseHeaders     String?  // JSON string
  responseBodyPreview String?
  
  // Analysis
  wasBlocked          Boolean  @default(false)
  blockReason         String?
  challengeDetected   Boolean  @default(false)
  challengeType       String?
  
  timingMs    Int?
  createdAt   DateTime @default(now())
  
  @@index([targetId])
  @@index([createdAt])
  @@index([wasBlocked])
}



<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≠ Phantom AI - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glow { box-shadow: 0 0 20px rgba(139, 92, 246, 0.3); }
        .status-red { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .status-yellow { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .status-green { background: linear-gradient(135deg, #10b981, #059669); }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .log-entry { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <header class="mb-8 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="text-4xl">üé≠</div>
                <div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                        Phantom AI
                    </h1>
                    <p class="text-gray-400 text-sm">Adaptive Web Crawler with MCP</p>
                </div>
            </div>
            <div class="flex gap-4">
                <div class="bg-gray-800 rounded-lg px-4 py-2 border border-gray-700">
                    <span class="text-xs text-gray-400">API Status</span>
                    <div id="api-status" class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
                        <span class="text-sm">Connecting...</span>
                    </div>
                </div>
                <button onclick="refreshData()" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg px-4 py-2 transition">
                    üîÑ Refresh
                </button>
            </div>
        </header>

        <!-- Add Target -->
        <section class="bg-gray-800 rounded-xl p-6 border border-gray-700 mb-6">
            <h2 class="text-lg font-semibold mb-4">‚ûï Add Target</h2>
            <div class="flex gap-4">
                <input type="url" id="target-url" placeholder="https://example.com" 
                    class="flex-1 bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none">
                <select id="target-type" class="bg-gray-900 border border-gray-600 rounded-lg px-4 py-2">
                    <option value="web">Web</option>
                    <option value="api">API</option>
                    <option value="spa">SPA</option>
                </select>
                <button onclick="addTarget()" class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-lg font-medium transition">
                    Add Target
                </button>
            </div>
        </section>

        <!-- Targets Grid -->
        <section id="targets-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="col-span-full text-center py-12 text-gray-500">
                Loading targets...
            </div>
        </section>

        <!-- MCP Analysis Section -->
        <section class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                üß† MCP Analysis Log
                <span class="text-xs bg-purple-600 px-2 py-1 rounded">Claude 4.5 Sonnet</span>
            </h2>
            <div id="mcp-logs" class="space-y-2 max-h-96 overflow-y-auto mono text-sm">
                <div class="text-gray-500 italic">No MCP analysis recorded yet...</div>
            </div>
        </section>
    </div>

    <script>
        const API_URL = 'http://localhost:4000';
        let activeCrawls = new Set();

        // Status colors
        const statusColors = {
            'RED': 'status-red',
            'YELLOW': 'status-yellow',
            'GREEN': 'status-green'
        };

        const statusIcons = {
            'RED': 'üî¥',
            'YELLOW': 'üü°',
            'GREEN': 'üü¢'
        };

        // Fetch targets
        async function fetchTargets() {
            try {
                const res = await fetch(`${API_URL}/api/targets`);
                const targets = await res.json();
                renderTargets(targets);
                document.getElementById('api-status').innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-green-500"></div>
                    <span class="text-sm text-green-400">Connected</span>
                `;
            } catch (err) {
                document.getElementById('api-status').innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-red-500"></div>
                    <span class="text-sm text-red-400">Disconnected</span>
                `;
            }
        }

        // Render targets
        function renderTargets(targets) {
            const container = document.getElementById('targets-container');
            
            if (!targets.length) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-500 bg-gray-800 rounded-xl border border-gray-700">
                        No targets yet. Add one above! üëÜ
                    </div>
                `;
                return;
            }

            container.innerHTML = targets.map(t => `
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 hover:border-gray-600 transition">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-2xl">${statusIcons[t.greenLightStatus]}</span>
                                <h3 class="font-semibold text-lg truncate" title="${t.url}">${t.url}</h3>
                            </div>
                            <div class="flex gap-4 text-sm text-gray-400">
                                <span>Type: <span class="text-gray-200">${t.type}</span></span>
                                <span>Status: <span class="text-gray-200">${t.status}</span></span>
                                <span>Events: <span class="text-gray-200">${t._count?.learningEvents || 0}</span></span>
                            </div>
                        </div>
                        <div class="w-12 h-12 rounded-full ${statusColors[t.greenLightStatus]} flex items-center justify-center font-bold text-lg">
                            ${t.trustScore}%
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-400">Trust Score</span>
                            <span class="text-gray-300">${t.trustScore}/100</span>
                        </div>
                        <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full ${statusColors[t.greenLightStatus]} transition-all duration-500" 
                                 style="width: ${t.trustScore}%"></div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-2">
                        <button onclick="startCrawl('${t.id}', '${t.url}')" 
                                ${activeCrawls.has(t.id) ? 'disabled' : ''}
                                class="flex-1 ${activeCrawls.has(t.id) ? 'bg-gray-700 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'} 
                                       text-white py-2 rounded-lg font-medium transition flex items-center justify-center gap-2">
                            ${activeCrawls.has(t.id) ? '‚è≥ Crawling...' : '‚ñ∂Ô∏è Start Crawl'}
                        </button>
                        <button onclick="analyzeTarget('${t.id}')" 
                                class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-medium transition">
                            üß† MCP Analyze
                        </button>
                        <button onclick="showDetails('${t.id}')" 
                                class="px-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                            üëÅÔ∏è
                        </button>
                    </div>

                    ${activeCrawls.has(t.id) ? `
                        <div class="mt-3 p-3 bg-gray-900 rounded-lg mono text-xs">
                            <div class="flex items-center gap-2 text-green-400 mb-2">
                                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                Crawling in progress...
                            </div>
                            <div id="crawl-log-${t.id}" class="space-y-1 text-gray-400 max-h-32 overflow-y-auto"></div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Add target
        async function addTarget() {
            const url = document.getElementById('target-url').value;
            const type = document.getElementById('target-type').value;
            
            if (!url) return;

            try {
                await fetch(`${API_URL}/api/targets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, type })
                });
                document.getElementById('target-url').value = '';
                fetchTargets();
            } catch (err) {
                alert('Failed to add target');
            }
        }

        // Start crawl via API
        async function startCrawl(targetId, url) {
            if (activeCrawls.has(targetId)) return;
            
            activeCrawls.add(targetId);
            renderTargets(await fetch(`${API_URL}/api/targets`).then(r => r.json()));
            
            // Start crawl via API endpoint
            try {
                await fetch(`${API_URL}/api/crawl/${targetId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                
                // Poll for updates
                const pollInterval = setInterval(async () => {
                    if (!activeCrawls.has(targetId)) {
                        clearInterval(pollInterval);
                        return;
                    }
                    await fetchTargets();
                }, 3000);
                
                // Auto-stop after 5 minutes
                setTimeout(() => {
                    activeCrawls.delete(targetId);
                    clearInterval(pollInterval);
                    fetchTargets();
                }, 300000);
                
            } catch (err) {
                console.error('Crawl failed:', err);
                activeCrawls.delete(targetId);
                fetchTargets();
            }
        }

        // MCP Analyze
        async function analyzeTarget(targetId) {
            try {
                const res = await fetch(`${API_URL}/api/mcp/analyze/${targetId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                addMcpLog(targetId, data);
            } catch (err) {
                console.error('MCP analysis failed:', err);
            }
        }

        // Add MCP log entry
        function addMcpLog(targetId, data) {
            const container = document.getElementById('mcp-logs');
            if (container.children[0]?.classList.contains('italic')) {
                container.innerHTML = '';
            }
            
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry bg-gray-900 rounded-lg p-3 border-l-4 border-purple-500';
            entry.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="text-purple-400 font-semibold">üß† MCP Analysis</span>
                    <span class="text-gray-500 text-xs">${timestamp}</span>
                </div>
                <div class="text-gray-300 mb-2">Target: ${data.target || targetId}</div>
                ${data.cdn ? `<div class="text-gray-400 text-xs mb-1">CDN: ${data.cdn}</div>` : ''}
                ${data.securityLevel ? `<div class="text-gray-400 text-xs mb-1">Security: ${data.securityLevel}</div>` : ''}
                ${data.recommendations ? `
                    <div class="mt-2 text-xs">
                        <div class="text-gray-500 mb-1">Recommendations:</div>
                        ${data.recommendations.map(r => `<div class="text-green-400">‚Ä¢ ${r}</div>`).join('')}
                    </div>
                ` : ''}
                ${data.suggestedDNA ? `
                    <div class="mt-2 text-xs">
                        <div class="text-gray-500 mb-1">DNA Mutations:</div>
                        <div class="bg-gray-800 rounded p-2 text-xs">
                            ${Object.entries(data.suggestedDNA).map(([k, v]) => 
                                `<div class="text-blue-400">${k}: ${JSON.stringify(v).substring(0, 100)}</div>`
                            ).join('')}
                        </div>
                    </div>
                ` : ''}
                ${data.bypassTechnique ? `
                    <div class="mt-2 p-2 bg-green-900/30 border border-green-700 rounded">
                        <div class="text-green-400 font-semibold">‚úÖ Bypass Applied</div>
                        <div class="text-green-300 text-xs mt-1">${data.bypassTechnique}</div>
                    </div>
                ` : ''}
            `;
            container.insertBefore(entry, container.firstChild);
        }

        // Show target details
        async function showDetails(targetId) {
            try {
                const res = await fetch(`${API_URL}/api/targets/${targetId}`);
                const data = await res.json();
                console.log('Target details:', data);
                // Could show a modal here
                alert(`Target: ${data.url}\nTrust: ${data.trustScore}%\nEvents: ${data._count?.learningEvents || 0}`);
            } catch (err) {
                console.error('Failed to fetch details:', err);
            }
        }

        // Refresh data
        function refreshData() {
            fetchTargets();
        }

        // Auto-refresh
        setInterval(fetchTargets, 5000);
        fetchTargets();
    </script>
</body>
</html>

